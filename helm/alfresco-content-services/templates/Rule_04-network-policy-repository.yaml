{{- if .Values.networkpolicysetting.enabled }}
# Allow repository communication with other components
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: repository
spec:
  podSelector:
    matchLabels:
      app: {{ template "content-services.shortname" . }}-repository
  policyTypes:
  - Ingress
  - Egress
  ingress:
    - from:
      # Allow traffic from nginx-ingress
      - podSelector:
          matchLabels:
            app: nginx-ingress

      {{- if index .Values "alfresco-search" "enabled" }}
      # Allow traffic from search
      - podSelector:
          matchLabels:
            app:  {{ template "alfresco-search.host" . }}
      {{- end }}

      # Allow traffic from share
      - podSelector:
          matchLabels:
            app: {{ template "content-services.shortname" . }}-share

      # Allow traffic from transformers
      - podSelector:
          matchLabels:
            component: transformers

      {{ if (index .Values "alfresco-insight-zeppelin") }}
      {{ if (index .Values "alfresco-insight-zeppelin" "enabled") }}
      # Allow traffic from Zeppelin
      - podSelector:
          matchLabels:
            app: {{ template "alfresco-insight-zeppelin.host" . }}
      {{ end }}
      {{ end }}

      ports:
        - protocol: TCP
          port: 8080
        - protocol: TCP
          port: 80

    # Allow traffic between repository members 
    - from:
      - podSelector:
          matchLabels:
            app: {{ template "content-services.shortname" . }}-repository
      ports:
        - protocol: TCP
          port: 5701
        {{- if .Values.email.server.enabled }}
        - protocol: TCP
          port: {{ .Values.mail.port }}
        - protocol: TCP
          port: {{ .Values.email.server.port }}
        - protocol: TCP
          port: {{ .Values.imap.server.port }}
        - protocol: TCP
          port: {{ .Values.imap.server.imaps.port }}
        {{ end }}

    {{- if .Values.email.server.enabled }}
    # Allow external repo connection for email, smtp and imap services
    - from:
      - ipBlock:
          cidr: 0.0.0.0/0
      ports:
      - protocol: TCP
        port: {{ .Values.email.server.port }}
      - protocol: TCP
        port: {{ .Values.imap.server.port }}
      - protocol: TCP
        port: {{ .Values.imap.server.imaps.port }}
    {{- end }}

  egress:
    # Allow repo to communicate back with other components
    - to:
      {{- if eq .Values.database.external false }}
      # Database
      - podSelector:
          matchLabels:
             app: {{ printf "%s-%s" .Release.Name .Values.postgresql.nameOverride }}
      {{- end }}
      # Repo (clustering)
      - podSelector:
          matchLabels:
             app: {{ template "content-services.shortname" . }}-repository

      {{- if index .Values "alfresco-search" "enabled" }}
      # Search (solr)
      - podSelector:
          matchLabels:
             app:  {{ template "alfresco-search.host" . }}
      {{- end }}

      # Share
      - podSelector:
          matchLabels:
             app: {{ template "content-services.shortname" . }}-share

      # Transformers
      - podSelector:
          matchLabels:
             component: transformers

      # Transform router (Transform Service)
      - podSelector:
          matchLabels:
            component: transformrouter
      
      # Activemq
      - podSelector:
          matchLabels:
            app: {{ printf "%s-%s" .Release.Name "activemq" }}
      
      # SFS
      - podSelector:
          matchLabels:
            app: {{ template "alfresco.shortname" . }}-filestore
                  
      # nginx-ingress
      - podSelector:
          matchLabels:
             app: nginx-ingress

    # Allow repo to connect HeartBeat (https://hbrx.alfresco.com)
    - to:
      - ipBlock:
          # AWS CloudFront CIDR range '52.84.0.0/15' is GLOBAL: https://ip-ranges.amazonaws.com/ip-ranges.json 
          # As of now there is no selector to specify a DNS name of a host (https://github.com/kubernetes/kubernetes/issues/50453)
          cidr: 52.84.0.0/15 
      ports:
      - protocol: TCP
        port: 443

    # Allow repository to communicate with EFS
    - to:
      - ipBlock:
          cidr: 0.0.0.0/0
      ports:
      - protocol: TCP
        port: 2049
      - protocol: TCP
        port: 61617
      - protocol: TCP
        port: 61616

    {{- if .Values.email.server.enabled }}
    # Allow repo connection for email, smtp and imap services
    - to:
      - ipBlock:
          cidr: 0.0.0.0/0
      ports:
      - protocol: TCP
        port: {{ .Values.mail.port }}
      - protocol: TCP
        port: {{ .Values.email.server.port }}
      - protocol: TCP
        port: {{ .Values.imap.server.port }}
      - protocol: TCP
        port: {{ .Values.imap.server.imaps.port }}
      {{- end }}
{{- end }}