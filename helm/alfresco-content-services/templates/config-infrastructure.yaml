---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Values.infrastructure.configMapName }}
  labels:
    {{- include "alfresco-content-services.labels" . | nindent 4 }}
data:
  {{- $repoCtx := dict "Values" (index .Values "alfresco-repository") "Chart" .Chart "Release" .Release }}
  repo_svc_name: {{ template "alfresco-repository.fullname" $repoCtx }}
  repo_svc_port: {{ .Values.repository.service.externalPort | quote }}
  {{- $db_url := include "alfresco-content-services.database.repo" $ }}
  {{ template "alfresco-repository.db.cm" (dict "url" $db_url "driver" .Values.database.driver) }}
  {{ template "alfresco-repository.mq.cm" (include "alfresco-content-services.mq.url" .) }}
  {{- $search_url := "" }}
  {{- $search_flavor := include "alfresco-content-services.search.flavor" . }}
  {{- $searchCtx := dict "Values" (index .Values "alfresco-search") "Chart" .Chart "Release" .Release }}
  {{- if index .Values "alfresco-search" "enabled" }}
  {{- $search_url = printf "http://%s-solr/solr" (include "alfresco-search-service.fullname" $searchCtx) }}
  SEARCH_HOST: {{ template "alfresco-common.url.host" $search_url }}
  SEARCH_PORT: {{ include "alfresco-common.url.port" $search_url | quote }}
  SOLR_BASE_URL: {{ include "alfresco-common.url.path" $search_url | default "/solr" }}
  {{- end }}
  {{- if ne "noindex" $search_flavor }}
  SEARCH_SECURECOMMS: {{ .Values.global.search.securecomms }}
  SEARCH_URL: {{ $search_url }}
  {{- end }}
  SEARCH_FLAVOR: {{ template "alfresco-content-services.search.flavor" . }}
