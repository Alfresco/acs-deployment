
[agent]
  collection_jitter = "0s"
  debug = false
  flush_interval = "10s"
  flush_jitter = "0s"
  hostname = "$HOSTNAME"
  interval = "10s"
  logfile = ""
  metric_batch_size = 1000
  metric_buffer_limit = 10000
  omit_hostname = false
  precision = ""
  quiet = false
  round_interval = true
[[processors.regex]]
  namepass = ["*"]
   [[processors.regex.tags]]
    key = "servicePath"
    pattern = "/alfresco/api/-default-/(private|public)/([^/]+)/versions/([0-9]+(\\.[0-9]+)*)/([^/]+)(/.*)?"
    replacement = "${5}"
    result_key = "alfresco_rest_api_endpoint"
   [[processors.regex.tags]]
    key = "servicePath"
    pattern = "/alfresco/api/-default-/(private|public)/([^/]+)/versions/([0-9]+(\\.[0-9]+)*)/([^/]+)(/.*)?"
    replacement = "${3}"
    result_key = "alfresco_rest_api_version"
   [[processors.regex.tags]]
    key = "servicePath"
    pattern = "/alfresco/api/-default-/(private|public)/([^/]+)/versions/([0-9]+(\\.[0-9]+)*)/([^/]+)(/.*)?"
    replacement = "${2}"
    result_key = "alfresco_rest_api_model"
   [[processors.regex.tag_rename]]
    pattern = "^servicePath$"
    replacement = ""

[[outputs.influxdb_v2]]
  bucket = "alfresco"
  organization = "alfresco"
  timeout = "5s"
  token = "influx"
  urls = [
    "http://influxdb2:8086"
  ]

[[inputs.prometheus]]
  urls = [
    "http://alfresco:8080/alfresco/s/prometheus"
  ]

[[processors.starlark]]
  order = 100
  source = '''
def apply(metric):
    if metric.name == "alfresco_repository_descriptor":
        if "VersionNumber" in metric.fields:
            state["VersionNumber"] = str(metric.fields["VersionNumber"])
            metric.tags["VersionNumber"] = state["VersionNumber"]
        return metric

    if metric.name == "alfresco_system_properties":
        if "java.runtime.version" in metric.fields:
            state["java_runtime_version"] = str(metric.fields["java.runtime.version"])
            metric.tags["java_runtime_version"] = state["java_runtime_version"]
        return metric

    if "VersionNumber" in state:
        metric.tags["VersionNumber"] = state["VersionNumber"]

    if "java_runtime_version" in state:
        metric.tags["java_runtime_version"] = state["java_runtime_version"]
    return metric
'''


[[inputs.jolokia2_agent]]
  urls = ["http://alfresco:7777/jolokia"]
  username = "admin"
  password = "admin"

  [[inputs.jolokia2_agent.metric]]
    name = "alfresco_authority"
    mbean = "Alfresco:Name=Authority"

  [[inputs.jolokia2_agent.metric]]
    name = "alfresco_cache_statistics"
    mbean = "Alfresco:Name=CacheStatistics,CacheName=*"
    tag_keys = ["CacheName"]

  [[inputs.jolokia2_agent.metric]]
    name = "alfresco_repo_server_mgmt"
    mbean = "Alfresco:Name=RepoServerMgmt"

  [[inputs.jolokia2_agent.metric]]
    name = "alfresco_repository_descriptor"
    mbean = "Alfresco:Name=RepositoryDescriptor,Type=Current"
    paths = ["VersionNumber"]
  
  [[inputs.jolokia2_agent.metric]]
    name = "alfresco_system_properties"
    mbean = "Alfresco:Name=SystemProperties"
    paths = ["java.runtime.version"]

  [[inputs.jolokia2_agent.metric]]
    name = "alfresco_runtime"
    mbean = "Alfresco:Name=Runtime"

  [[inputs.jolokia2_agent.metric]]
    name = "catalina_global_request_processor"
    mbean = "Catalina:type=GlobalRequestProcessor,name=\"http-nio-8080\""

  [[inputs.jolokia2_agent.metric]]
    name = "catalina_thread_pool"
    mbean = "Catalina:type=Manager,host=*,context=*"
    tag_keys = ["host","context"]
    tag_prefix = "catalina_thread_pool_"

  [[inputs.jolokia2_agent.metric]]
    name = "catalina_servlet"
    mbean = "Catalina:j2eeType=Servlet,WebModule=*,name=*,J2EEApplication=*,J2EEServer=*"
    tag_keys = ["WebModule","name","J2EEApplication","J2EEServer"]
    tag_prefix = "catalina_servlet_"
  
  [[inputs.jolokia2_agent.metric]]
    name = "catalina_thread_pool_http"
    mbean = "Catalina:type=ThreadPool,name=\"http-nio-8080\""

  [[inputs.jolokia2_agent.metric]]
    name = "catalina_utility_executor"
    mbean = "Catalina:type=UtilityExecutor"

  [[inputs.jolokia2_agent.metric]]
    name = "catalina_web_module"
    mbean = "Catalina:j2eeType=WebModule,name=*,J2EEApplication=*,J2EEServer=*"
    tag_keys = ["name","J2EEApplication","J2EEServer"]
    tag_prefix = "catalina_web_module_"

[[inputs.internal]]
  collect_memstats = false
