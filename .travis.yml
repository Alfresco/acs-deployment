language: python
python:
  - "3.8.2"

os: linux
dist: xenial

services:
  - docker

import:
  - Alfresco/alfresco-process-tools:.travis.helm.yml@master
  - Alfresco/alfresco-process-tools:.travis.kubernetes_install.yml@master
  - Alfresco/alfresco-process-tools:.travis.docker_login.yml@master

env:
  global:
    - TRAVIS_WAIT_TIMEOUT=${TRAVIS_WAIT_TIMEOUT:-30}
    - BRANCH=${TRAVIS_PULL_REQUEST_BRANCH:-${TRAVIS_BRANCH}}
    - HELM_REPO_BASE_URL=https://kubernetes-charts.alfresco.com
    - HELM_REPO=stable
    - KUBERNETES_VERSION=${KUBERNETES_VERSION:-1.16.8}

branches:
  only:
    - OPSEXP-115

before_install:
  - |
    pip install --upgrade awscli
    curl -o aws-iam-authenticator https://amazon-eks.s3.us-west-2.amazonaws.com/1.16.8/2020-04-16/bin/linux/amd64/aws-iam-authenticator
    curl -o aws-iam-authenticator.sha256 https://amazon-eks.s3.us-west-2.amazonaws.com/1.16.8/2020-04-16/bin/linux/amd64/aws-iam-authenticator.sha256
    openssl sha1 -sha256 aws-iam-authenticator
    chmod +x ./aws-iam-authenticator
    mkdir -p $HOME/bin && cp ./aws-iam-authenticator $HOME/bin/aws-iam-authenticator && export PATH=$PATH:$HOME/bin
    export PATH=$PATH:$HOME/bin
    aws eks update-kubeconfig --name acs-cluster --region=eu-west-1

before_script:
  - |
    REPO_NAME=${TRAVIS_REPO_SLUG##*/}
    PROJECT_NAME=alfresco-content-services
    helm repo add activiti https://activiti.github.io/activiti-cloud-helm-charts
    helm repo add alfresco ${HELM_REPO_BASE_URL}/stable
    if [[ "${TRAVIS_BRANCH}" != *"support/"* ]]
    then
      export HELM_REPO=incubator
      helm repo add alfresco-incubator ${HELM_REPO_BASE_URL}/${HELM_REPO}
    fi
    echo using PROJECT_NAME=${PROJECT_NAME},BRANCH=${BRANCH},HELM_REPO=${HELM_REPO}

jobs:
  include:
    - name: Deploy Chart and Run Postman Checks
      stage: test
      script: |
        namespace=${TRAVIS_BRANCH}-${TRAVIS_BUILD_NUMBER}
        # kubectl create namespace "$namespace"
        # kubectl create secret docker-registry quay-registry-secret --docker-server=${DOCKER_REGISTRY} --docker-username=${DOCKER_REGISTRY_USERNAME} --docker-password=${DOCKER_REGISTRY_PASSWORD} -n "$namespace"
        # kubectl -n $namespace create role $namespace:psp --verb=use --resource=podsecuritypolicy --resource-name=kube-system
        # kubectl -n $namespace create rolebinding $namespace:psp:default --role=$namespace:psp --serviceaccount=$namespace:default
        # cd helm/alfresco-content-services
        # helm dependency update
    - name: Deploy Docker Compose and Run Postman Checks
      stage: test
      script: |
        cd docker-compose
        /bin/bash startup.sh
        cd ../test/postman/docker-compose
        docker run -a STDOUT --volume $PWD:/etc/newman --network host postman/newman_alpine33:3.9.2 run "acs-test-docker-compose-collection.json" --insecure --global-var "protocol=http" --global-var "url=localhost:8080"
      after_failure: |
        docker-compose logs --no-color