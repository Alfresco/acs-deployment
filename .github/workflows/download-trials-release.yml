---
name: Release Download trials

on:
  workflow_dispatch:

env:
  DEFAULT_BRANCH_NAME: master
  TRIALS_BRANCH_NAME: download-trial

jobs:
  createPR:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    name: Create PR for download trials
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
        with:
          ref: ${{ env.TRIALS_BRANCH_NAME }}

      - name: Generate Download trial compose files
        working-directory: docker-compose
        run: |
          git restore --source ${{ env.DEFAULT_BRANCH_NAME }} --staged docker-compose/compose.yaml docker-compose/community-compose.yaml commons/
          docker compose -f compose.yaml config -o docker-compose.yml \
          && rm compose.yaml
          docker compose -f community-compose.yaml config -o community-docker-compose.yml \
          && rm community-compose.yaml

      - name: Commit updated compose files
        uses: stefanzweifel/git-auto-commit-action@e348103e9026cc0eee72ae06630dbe30c8bf7a79  # v5.1.0
        with:
          commit_message: |
            ðŸ›  Update download trial compose files
          commit_user_name: ${{ vars.BOT_GITHUB_USERNAME }}
          commit_user_email: ${{ vars.BOT_GITHUB_EMAIL }}
          branch: download-trials-${{ github.run_id }}-${{ hashFiles('docker-compose.yml', 'community-docker-compose.yml') }}
          create_branch: true
          file_pattern: >-
            docker-compose/docker-compose.yml
            docker-compose/community-docker-compose.yml
