---
name: Images updates for ACS 7.0.N

{{- define "quay_auth" }}
      username: {{ requiredEnv "QUAY_USERNAME" }}
      password: {{ requiredEnv "QUAY_PASSWORD" }}
{{- end }}

{{- define "wip_pattern" -}}
  (-[AM]\.?[0-9]+)?
{{- end }}

{{- define "hf_pattern" -}}
  (\.[0-9]+){1,3}
{{- end }}

{{- define "ga_pattern" -}}
  (\.[0-9]+){1,2}
{{- end }}

scms:

sources:
  syncTag:
    name: Sync Service image tag
    kind: dockerimage
    spec:
      image: quay.io/alfresco/service-sync
      {{ template "quay_auth" }}
      versionFilter:
        kind: regex
        pattern: >-
          ^{{ index . "sync" "version" }}{{ template "hf_pattern" }}$
  adwTag:
    name: Alfresco Digital Workspace tag
    kind: dockerimage
    spec:
      image: quay.io/alfresco/alfresco-digital-workspace
      {{ template "quay_auth" }}
      versionFilter:
        kind: regex
        pattern: >-
          ^{{ index . "adw" "version" }}{{ template "ga_pattern" }}$
  repositoryTag:
    name: ACS repository tag
    kind: dockerimage
    spec:
      image: quay.io/alfresco/alfresco-content-repository
      {{ template "quay_auth" }}
      versionFilter:
        kind: regex
        pattern: >-
          ^{{ index . "acs" "version" }}{{ template "hf_pattern" }}$
  shareTag:
    name: Share repository tag
    kind: dockerimage
    spec:
      image: quay.io/alfresco/alfresco-share
      {{ template "quay_auth" }}
      versionFilter:
        kind: regex
        pattern: >-
          ^{{ index . "share" "version" }}{{ template "hf_pattern" }}$

targets:
  repositoryCompose:
    name: Repo image tag
    kind: yaml
    sourceid: repositoryTag
    transformers:
      - addprefix: "quay.io/alfresco/alfresco-content-repository:"
    spec:
      file: {{ .acs.compose_target }}
      key: >-
        {{ .acs.compose_key }}
  repositoryValues:
    name: Repo image tag
    kind: yaml
    sourceid: repositoryTag
    spec:
      file: {{ .acs.helm_target }}
      key: >-
        {{ .acs.helm_key }}
  shareCompose:
    name: Share image tag
    kind: yaml
    sourceid: shareTag
    transformers:
      - addprefix: "quay.io/alfresco/alfresco-share:"
    spec:
      file: {{ .share.compose_target }}
      key: >-
        {{ .share.compose_key }}
  shareValues:
    name: Share image tag
    kind: yaml
    sourceid: shareTag
    spec:
      file: {{ .share.helm_target }}
      key: >-
        {{ .share.helm_key }}
  syncCompose:
    name: Sync image tag
    kind: yaml
    sourceid: syncTag
    transformers:
      - addprefix: "quay.io/alfresco/service-sync:"
    spec:
      file: {{ .sync.compose_target }}
      key: >-
        {{ .sync.compose_key }}
  syncValues:
    name: Sync image tag
    kind: yaml
    sourceid: syncTag
    spec:
      file: {{ .sync.helm_target }}
      key: >-
        {{ .sync.helm_key }}
  adwCompose:
    name: ADW image tag
    kind: yaml
    sourceid: adwTag
    transformers:
      - addprefix: "quay.io/alfresco/alfresco-digital-workspace:"
    spec:
      file: {{ .adw.compose_target }}
      key: >-
        {{ .adw.compose_key }}
  adwValues:
    name: ADW image tag
    kind: yaml
    sourceid: adwTag
    spec:
      file: {{ .adw.helm_target }}
      key: >-
        {{ .adw.helm_key }}
